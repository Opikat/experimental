# PRD: Figma-плагин для автонастройки интерлиньяжа и трекинга

## 1. Обзор продукта

### Название (рабочее)
**TypeTune**

### Проблема
Дизайнеры тратят значительное время на ручную настройку `line-height` и `letter-spacing` для каждого текстового слоя. Стандартные значения Figma (`line-height: auto`, `letter-spacing: 0`) дают неоптимальный результат: текст выглядит либо слишком плотно, либо слишком разреженно. Подбор правильных значений требует экспертизы в типографике и знания метрик конкретного шрифта.

### Решение
Figma-плагин, который автоматически рассчитывает и применяет оптимальные значения `line-height` и `letter-spacing` к выделенным текстовым слоям, учитывая:
- метрики конкретного шрифта (ascender, descender, x-height, cap-height)
- кегль (font-size)
- начертание (weight)
- регистр текста (uppercase / mixed case)
- контраст фона (светлый / тёмный)

### Референс
Аналог — плагин [TypeBalance](https://www.figma.com/community/plugin/1343994326021053695/typebalance) от Dmitriy Vaganov. Он использует базу данных оптимальных значений для 200+ шрифтов, подобранных с помощью computer vision. Наш подход: открытая формульная система с возможностью кастомизации, а не закрытая БД.

---

## 2. Целевая аудитория

| Сегмент | Потребность |
|---------|-------------|
| UI/UX-дизайнеры | Быстро получить читаемый текст без ручного подбора |
| Дизайн-системщики | Генерировать консистентные типографические токены |
| Начинающие дизайнеры | Получить «правильные» значения, не зная теории типографики |
| Верстальщики | Получить точные значения для переноса в CSS |

---

## 3. Функциональные требования

### 3.1. Автоподбор line-height (интерлиньяж)

**Входные параметры:**
- Семейство шрифта (font family)
- Кегль (font size, 8–210 px)
- Начертание (font weight)
- Контекст: заголовок (display) / основной текст (body) / подпись (caption)

**Логика расчёта:**

Базовая формула:

```
line-height = fontSize * baseRatio * contextMultiplier * weightAdjustment
```

Где:
- `baseRatio` — зависит от метрик шрифта: `(ascender + |descender| + opticalPadding) / unitsPerEm`. Для большинства шрифтов в диапазоне 1.15–1.6
- `contextMultiplier`:
  - Display (≥32px): 0.85–1.0 (плотнее)
  - Body (14–31px): 1.0 (нормально)
  - Caption (≤13px): 1.05–1.15 (свободнее)
- `weightAdjustment`: тонкие начертания (100–300) → +2–3%, жирные (700–900) → -2–3%

**Особые случаи:**
- Однострочные элементы (кнопки, лейблы): `line-height = fontSize` (100%) для вертикального центрирования
- Крупные display-заголовки (≥64px): автоматическое снижение до 90–100% для визуальной плотности

### 3.2. Автоподбор letter-spacing (трекинг)

**Входные параметры:**
- Семейство шрифта
- Кегль
- Регистр (uppercase / mixed case / lowercase)

**Логика расчёта:**

```
letter-spacing = fontSize * baseTracking * sizeScaling * caseAdjustment * bgAdjustment
```

Где:
- `baseTracking` — специфичен для шрифта. Шрифты с плотным трекингом от природы (condensed) получают положительную коррекцию; широкие — отрицательную
- `sizeScaling` — обратная зависимость от размера:
  - ≤12px: +0.5–1.0%
  - 13–24px: 0 (нейтрально)
  - 25–48px: -0.5–1.5%
  - ≥49px: -1.5–3.0%
- `caseAdjustment` — для uppercase: +5–10% к базовому трекингу (формы букв крупнее и длиннее, нужно больше воздуха)
- `bgAdjustment` — светлый фон: 0, тёмный фон: +1–3% (текст на тёмном визуально кажется жирнее, нужен дополнительный трекинг)

### 3.3. Адаптация к фону (светлый / тёмный)

Текст на тёмном фоне визуально выглядит жирнее из-за оптической иллюзии (иррадиация). Плагин анализирует fill родительского фрейма или явно заданный пользователем режим и корректирует:
- `letter-spacing`: +1–3% на тёмном фоне
- `line-height`: +1–2% на тёмном фоне

**Способ определения фона:**
1. Проверить fill ближайшего родительского фрейма/компонента
2. Вычислить яркость через формулу relative luminance: `L = 0.2126*R + 0.7152*G + 0.0722*B`
3. `L < 0.5` → тёмный фон

### 3.4. База данных шрифтов

Для каждого поддерживаемого шрифта хранятся кастомные коэффициенты:

```typescript
interface FontProfile {
  family: string;
  baseLineHeightRatio: number;    // оптимальный базовый множитель line-height
  baseTrackingRatio: number;      // оптимальный базовый множитель letter-spacing
  displayTightening: number;      // коррекция для display-размеров
  uppercaseBoost: number;         // дополнительный трекинг для uppercase
  weights: Record<number, {       // коррекции для конкретных начертаний
    lineHeightAdjust: number;
    trackingAdjust: number;
  }>;
}
```

**Приоритет шрифтов для первого релиза (Tier 1, 30 шрифтов):**
- Google Fonts топ-20: Inter, Roboto, Open Sans, Montserrat, Lato, Poppins, Noto Sans, Raleway, Ubuntu, Nunito, Playfair Display, PT Sans, Merriweather, Rubik, Work Sans, DM Sans, Manrope, Space Grotesk, IBM Plex Sans, Jost
- Популярные коммерческие: SF Pro, Neue Montreal, Golos, Graphik, Gilroy, TT Norms Pro, Basis Grotesque, Suisse Int'l, Helios, Druk

**Фоллбэк:** для шрифтов вне базы — использовать универсальные формулы на основе OpenType-метрик шрифта (доступны через Figma Plugin API: `fontName`, `fontSize`, `lineHeight`).

### 3.5. Пользовательский интерфейс

**Главный экран:**

```
┌─────────────────────────────────┐
│  TypeTune                    ×  │
├─────────────────────────────────┤
│                                 │
│  Контекст:  [Display ▼]        │
│  Фон:      ○ Авто  ○ Светлый  ○ Тёмный │
│                                 │
│  ─── Результат ──────────────── │
│                                 │
│  Line-height:   120%   [0.54]  │
│  Letter-spacing: 0.54px [0.03] │
│                                 │
│  ┌───────────┐  ┌───────────┐  │
│  │  Применить │  │ Применить  │  │
│  │ к выбранным│  │  ко всем   │  │
│  └───────────┘  └───────────┘  │
│                                 │
│  ☐ Обновлять при изменении     │
│    выделения                    │
│                                 │
├─────────────────────────────────┤
│  Превью                        │
│  ┌─────────────────────────┐   │
│  │ До:  Съешь ещё этих     │   │
│  │      мягких французских │   │
│  │      булок               │   │
│  ├─────────────────────────┤   │
│  │ После: Съешь ещё этих   │   │
│  │        мягких французских│  │
│  │        булок             │   │
│  └─────────────────────────┘   │
└─────────────────────────────────┘
```

**Режимы работы:**
1. **Ручной** — выделить текстовые слои → нажать «Применить»
2. **Автоматический** — подписка на событие `selectionchange`, пересчёт при каждом выделении текстового слоя (opt-in)
3. **Пакетный** — применить ко всем текстовым слоям на странице/во фрейме

---

## 4. Нефункциональные требования

| Требование | Значение |
|-----------|----------|
| Время отклика | < 100ms на один текстовый слой |
| Пакетная обработка | < 2s на 500 текстовых слоёв |
| Размер плагина | < 500 KB (без внешних зависимостей) |
| Figma API | Plugin API, не REST API — работа без токенов |
| Хранение настроек | `figma.clientStorage` для пользовательских преференций |
| Offline | Полная работа без интернета (база шрифтов встроена) |

---

## 5. Технический дизайн

### Стек
- **UI:** Figma Plugin API + Preact (легковесный, < 4 KB)
- **Логика:** TypeScript
- **Сборка:** esbuild (быстрая сборка, tree-shaking)
- **Тесты:** Vitest

### Архитектура

```
┌──────────────┐     postMessage     ┌──────────────────┐
│   UI (iframe) │ ◄────────────────► │  Main thread      │
│   Preact app  │                    │  (sandbox)        │
│               │                    │                   │
│  - контролы   │                    │  - FontDatabase   │
│  - превью     │                    │  - Calculator     │
│               │                    │  - NodeTraverser  │
│               │                    │  - BgAnalyzer     │
└──────────────┘                    └──────────────────┘
```

**Ключевые модули:**

| Модуль | Ответственность |
|--------|-----------------|
| `FontDatabase` | Хранение и поиск профилей шрифтов |
| `Calculator` | Расчёт оптимальных line-height и letter-spacing |
| `NodeTraverser` | Обход дерева нод Figma, фильтрация TextNode |
| `BgAnalyzer` | Определение яркости фона ближайшего родителя |
| `Applier` | Применение рассчитанных значений к текстовым нодам |

### Figma Plugin API — используемые методы

```typescript
// Чтение
figma.currentPage.selection        // выделенные ноды
node.type === 'TEXT'               // фильтр текстовых нод
node.fontName                      // семейство + стиль
node.fontSize                      // кегль
node.textCase                      // UPPER / ORIGINAL / ...
node.parent.fills                  // fill родителя для анализа фона

// Запись
node.lineHeight = { value: 120, unit: 'PERCENT' }
node.letterSpacing = { value: 0.54, unit: 'PIXELS' }

// Хранение
figma.clientStorage.getAsync(key)
figma.clientStorage.setAsync(key, value)
```

---

## 6. Метрики успеха

| Метрика | Цель (3 мес.) |
|---------|---------------|
| Установки (Figma Community) | 1 000 |
| WAU (weekly active users) | 300 |
| Avg. применений на сессию | ≥ 3 |
| Рейтинг в Community | ≥ 4.5 / 5 |
| Шрифтов в базе | 50 (Tier 1 + Tier 2) |

---

## 7. Этапы разработки

### MVP (v0.1) — 3 недели
- [ ] Базовый расчёт line-height и letter-spacing по универсальным формулам
- [ ] Поддержка 30 шрифтов (Tier 1) с кастомными профилями
- [ ] Применение к выделенным текстовым слоям
- [ ] Определение контекста: display / body / caption по размеру
- [ ] Минимальный UI: кнопка «Применить» + отображение значений

### v0.2 — 2 недели
- [ ] Определение и адаптация к светлому/тёмному фону
- [ ] Поддержка uppercase
- [ ] Превью «до / после» в UI плагина
- [ ] Пакетное применение ко всем текстовым слоям на странице

### v0.3 — 2 недели
- [ ] Автоматический режим (применение при смене выделения)
- [ ] Расширение базы до 50 шрифтов (Tier 2)
- [ ] Учёт начертания (weight) в расчёте
- [ ] Экспорт значений как CSS / дизайн-токены (JSON)

### v1.0 — 2 недели
- [ ] Пользовательские профили шрифтов (кастомные коэффициенты)
- [ ] Интеграция с Figma Variables: запись оптимальных значений как переменных
- [ ] Полировка UI, онбординг, документация
- [ ] Публикация в Figma Community

---

## 8. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|------------|---------|-----------|
| Figma Plugin API не даёт доступ к метрикам шрифта (ascender/descender) | Высокая | Высокое | Хранить метрики в собственной БД; для неизвестных шрифтов — использовать эвристики на основе fontSize |
| Mixed fonts в одном TextNode (разные стили в одном блоке) | Средняя | Среднее | Использовать `getRangeFontName()` / `getRangeFontSize()` для посегментной обработки |
| Субъективность «оптимальных» значений | Высокая | Среднее | Дать пользователю ручную подстройку коэффициентов; показывать «рекомендовано» как отправную точку |
| Шрифт не в базе | Высокая | Низкое | Фоллбэк на универсальные формулы; UI-индикатор «используется приближённый расчёт» |

---

## 9. Отличия от TypeBalance

| Аспект | TypeBalance | TypeTune (наш) |
|--------|-------------|----------------|
| Подход | Закрытая БД значений, подобранных через CV | Открытые формулы + кастомные профили |
| Кастомизация | Нет | Пользователь может подстроить коэффициенты |
| Экспорт | Нет | CSS / JSON дизайн-токены |
| Figma Variables | Нет | Запись в Variables |
| Превью | Нет | До / после в UI |
| Фоллбэк | Шрифт не поддерживается → ничего | Универсальные формулы для любого шрифта |
| Код | Закрытый | Открытый (MIT) |
